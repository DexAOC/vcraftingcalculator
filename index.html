<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculadora V Rising</title>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    :root {
      --bg: #f4f4f4;
      --text: #2c3e50;
      --sidebar: #2c3e50;
      --button: #34495e;
      --hover: #1abc9c;
      --detail-bg: #fff;
      --detail-text: #222;
    }
    [data-theme="dark"] {
      --bg: #121212;
      --text: #eee;
      --sidebar: #222;
      --button: #333;
      --hover: #3498db;
      --detail-bg: #222;
      --detail-text: #eee;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: Arial, sans-serif;
      display: flex;
      height: 100vh;
      background-color: var(--bg);
      color: var(--text);
      transition: background-color 0.3s, color 0.3s;
      position: relative;
    }

    .sidebar {
      width: 220px;
      background-color: var(--sidebar);
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 15px;
      overflow-y: auto;
    }
    .sidebar h2 {
      color: white;
      font-size: 18px;
      margin-bottom: 20px;
      border-bottom: 1px solid #444;
      padding-bottom: 10px;
    }
    .menu-button {
      padding: 12px;
      font-size: 16px;
      color: white;
      background-color: var(--button);
      border: none;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: background-color 0.3s ease;
      text-align: left;
    }
    .menu-button:hover,
    .menu-button[aria-pressed="true"] {
      background-color: var(--hover);
    }

    .main-content {
      flex: 1;
      padding: 30px;
      overflow-y: auto;
      max-width: 700px;
      position: relative;
    }
    .main-content h1 {
      font-size: 32px;
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin: 10px 0 5px 0;
    }
    select, input[type="number"], input[type="text"] {
      padding: 8px;
      font-size: 16px;
      width: 100%;
      max-width: 300px;
      margin-bottom: 15px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    ul#suggestions {
      max-width: 300px;
      list-style: none;
      margin: 0;
      padding: 0;
      border: 1px solid #ccc;
      border-radius: 6px;
      background: var(--detail-bg);
      position: absolute;
      z-index: 10;
    }
    ul#suggestions li {
      padding: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
    }
    ul#suggestions li:hover {
      background-color: var(--hover);
      color: white;
    }

    button.calculate-btn {
      background-color: var(--button);
      color: white;
      border: none;
      border-radius: 6px;
      padding: 10px 20px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s ease;
    }
    button.calculate-btn:hover {
      background-color: var(--hover);
    }

    .result-container {
      margin-top: 20px;
      background: var(--detail-bg);
      color: var(--detail-text);
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      position: relative;
    }
    .result-container h2 {
      margin-bottom: 15px;
    }
    .result-container ul {
      list-style: none;
      padding-left: 0;
    }
    .result-container li {
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
      position: relative;
    }
    .result-container li img {
      width: 20px;
      height: 20px;
      object-fit: contain;
      border-radius: 4px;
    }
    .item-image {
      float: right;
      max-width: 80px;
      margin-left: 15px;
      border-radius: 6px;
    }

    .theme-toggle {
      margin-top: auto;
      padding: 10px;
      background: var(--button);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    /* Bancada links */
    a.workstation-link {
      color: var(--hover);
      cursor: pointer;
      text-decoration: underline;
    }
    a.workstation-link:hover {
      color: #16a085;
    }

    /* Página bancada */
    .workstation-page {
      max-width: 700px;
      background: var(--detail-bg);
      color: var(--detail-text);
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      margin-top: 20px;
    }
    .workstation-page img {
      max-width: 150px;
      border-radius: 8px;
      margin-bottom: 15px;
      display: block;
    }
    .workstation-page h2 {
      margin-bottom: 10px;
    }
    .workstation-page h3 {
      margin-top: 15px;
    }
    .workstation-page ul {
      list-style: disc inside;
      margin-left: 10px;
    }

    /* Tooltip bancada */
    #tooltip-workstation {
      position: absolute;
      pointer-events: none;
      background: var(--detail-bg);
      color: var(--detail-text);
      border: 1px solid var(--hover);
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 14px;
      white-space: nowrap;
      z-index: 9999;
      box-shadow: 0 0 6px rgba(0,0,0,0.3);
      display: none;
      align-items: center;
      gap: 6px;
    }
    #tooltip-workstation img {
      width: 24px;
      height: 24px;
      border-radius: 4px;
      object-fit: contain;
    }

    @media (max-width: 768px) {
      body {
        flex-direction: column;
      }
      .sidebar {
        width: 100%;
        flex-direction: row;
        flex-wrap: wrap;
        overflow-x: auto;
        justify-content: space-around;
      }
      .menu-button, .theme-toggle {
        flex: 1 1 auto;
        margin: 5px;
        text-align: center;
      }
      .main-content {
        max-width: 100%;
        padding: 15px;
      }
    }
  </style>
</head>
<body>
  <aside class="sidebar" aria-label="Menu de navegação">
    <h2>Bancadas</h2>
    <div id="workbench-list">
      <!-- Lista de bancadas preenchida por JS -->
    </div>
    <button class="theme-toggle" aria-pressed="false">Modo Escuro</button>
  </aside>

  <main class="main-content" tabindex="0">
    <h1>Calculadora de Crafting - V Rising</h1>
    <label for="item-select">Escolha o item:</label>
    <input type="text" id="item-select" placeholder="Digite o nome do item..." autocomplete="off" />
    <ul id="suggestions"></ul>

    <label for="quantity">Quantidade:</label>
    <input type="number" id="quantity" value="1" min="1" />

    <button class="calculate-btn">Calcular Materiais</button>

    <div id="result" class="result-container" aria-live="polite"></div>

    <div id="workstation-page" class="workstation-page" style="display:none;"></div>
  </main>

  <div id="tooltip-workstation" role="tooltip" aria-hidden="true"></div>

  <script>
    let itemData = [];
    let workstations = {};
    let selectedItem = null;
    const itemSelect = document.getElementById('item-select');
    const quantityInput = document.getElementById('quantity');
    const suggestionsList = document.getElementById('suggestions');
    const resultDiv = document.getElementById('result');
    const workbenchListDiv = document.getElementById('workbench-list');
    const workstationPageDiv = document.getElementById('workstation-page');
    const tooltip = document.getElementById('tooltip-workstation');
    const themeToggleBtn = document.querySelector('.theme-toggle');

    // Carrega dados dos arquivos JSON
    async function loadData() {
      try {
        const itemsResp = await fetch('items.json');
        const itemsJson = await itemsResp.json();
        itemData = itemsJson.items;

        const wbResp = await fetch('workbenches.json');
        const wbJson = await wbResp.json();

        workstations = {};
        wbJson.workbenches.forEach(wb => {
          workstations[wb.id] = wb;
        });

        populateWorkbenchSidebar();
        setupAutocomplete();
      } catch (e) {
        alert('Erro ao carregar dados: ' + e);
      }
    }

    // Preenche a sidebar com as bancadas como botões
    function populateWorkbenchSidebar() {
      workbenchListDiv.innerHTML = '';
      Object.values(workstations).forEach(wb => {
        const btn = document.createElement('button');
        btn.className = 'menu-button';
        btn.textContent = wb.name;
        btn.setAttribute('data-id', wb.id);
        btn.setAttribute('aria-pressed', 'false');
        btn.addEventListener('click', () => showWorkbenchPage(wb.id));
        workbenchListDiv.appendChild(btn);
      });
    }

    // Exibe a página dedicada da bancada selecionada
    function showWorkbenchPage(id) {
      // Desmarca botões
      document.querySelectorAll('.menu-button').forEach(btn => {
        btn.setAttribute('aria-pressed', 'false');
      });

      // Marca botão atual
      const currentBtn = [...document.querySelectorAll('.menu-button')].find(b => b.getAttribute('data-id') === id);
      if (currentBtn) currentBtn.setAttribute('aria-pressed', 'true');

      const wb = workstations[id];
      if (!wb) return;

      // Filtra itens que usam essa bancada como workstation
      const producedItems = itemData.filter(i => i.workstation === id);

      // Filtra itens que usam essa bancada como origin (exemplo, aqui só como placeholder)
      // Como não temos dados específicos, vamos mostrar somente produzidos
      workstationPageDiv.innerHTML = `
        <img src="${wb.image}" alt="Imagem da bancada ${wb.name}" />
        <h2>${wb.name}</h2>
        <p>${wb.description}</p>

        <h3>Itens produzidos:</h3>
        <ul>
          ${producedItems.length > 0 ? producedItems.map(i => `<li><img src="${i.image}" alt="${i.name}" /> ${i.name}</li>`).join('') : '<li>Nenhum item encontrado.</li>'}
        </ul>
      `;
      workstationPageDiv.style.display = 'block';
      resultDiv.style.display = 'none';
    }

    // Setup do autocomplete para o input de item
    function setupAutocomplete() {
      itemSelect.addEventListener('input', () => {
        const query = itemSelect.value.toLowerCase();
        suggestionsList.innerHTML = '';

        if (query.length === 0) {
          selectedItem = null;
          return;
        }

        const filtered = itemData.filter(i => i.name.toLowerCase().includes(query)).slice(0, 10);

        filtered.forEach(i => {
          const li = document.createElement('li');
          li.textContent = i.name;
          li.tabIndex = 0;
          li.addEventListener('click', () => {
            selectItem(i);
          });
          li.addEventListener('keydown', e => {
            if (e.key === 'Enter') selectItem(i);
          });
          suggestionsList.appendChild(li);
        });
      });

      // Fecha sugestões ao clicar fora
      document.addEventListener('click', e => {
        if (!itemSelect.contains(e.target) && !suggestionsList.contains(e.target)) {
          suggestionsList.innerHTML = '';
        }
      });
    }

    // Seleciona um item da lista
    function selectItem(item) {
      selectedItem = item;
      itemSelect.value = item.name;
      suggestionsList.innerHTML = '';
      resultDiv.style.display = 'block';
      workstationPageDiv.style.display = 'none';
      renderResult();
    }

    // Renderiza o resultado da receita
    function renderResult() {
      if (!selectedItem) {
        resultDiv.innerHTML = '';
        return;
      }

      const qty = parseInt(quantityInput.value) || 1;
      const item = selectedItem;

      let html = `
        <h2>Receita para ${qty}x ${item.name}</h2>
        <img src="${item.image}" alt="${item.name}" class="item-image" />
        <p>${item.description}</p>
        <p><strong>Origem:</strong> ${item.origin}</p>
      `;

      if (item.crafting && item.crafting.materials.length > 0) {
        html += '<h3>Materiais necessários:</h3><ul>';
        item.crafting.materials.forEach(mat => {
          const matItem = itemData.find(i => i.id === mat.item);
          if (!matItem) return;
          html += `
            <li>
              <img src="${matItem.image}" alt="${matItem.name}" />
              ${matItem.name} x ${mat.quantity * qty} 
              ${matItem.workstation ? `<a href="#" class="workstation-link" data-station="${matItem.workstation}">[${workstations[matItem.workstation]?.name || 'Bancada'}]</a>` : ''}
            </li>
          `;
        });
        html += '</ul>';
      } else {
        html += '<p>Este item não requer crafting.</p>';
      }

      // Se o item tem workstation, mostra link para a bancada
      if (item.workstation) {
        const wb = workstations[item.workstation];
        if (wb) {
          html += `<p><strong>Produzido na bancada:</strong> <a href="#" class="workstation-link" data-station="${wb.id}">${wb.name}</a></p>`;
        }
      }

      resultDiv.innerHTML = html;

      // Adiciona event listeners aos links das bancadas para abrir a página da bancada
      document.querySelectorAll('a.workstation-link').forEach(link => {
        link.addEventListener('click', e => {
          e.preventDefault();
          const stationId = link.getAttribute('data-station');
          showWorkbenchPage(stationId);
        });

        // Tooltip bancadas ao passar o mouse
        link.addEventListener('mousemove', e => {
          const stationId = link.getAttribute('data-station');
          showTooltip(e, stationId);
        });
        link.addEventListener('mouseleave', e => {
          hideTooltip();
        });
      });
    }

    // Calcula e mostra os materiais (botão calcular)
    document.querySelector('.calculate-btn').addEventListener('click', () => {
      if (!selectedItem) {
        alert('Por favor, selecione um item válido.');
        return;
      }
      renderResult();
    });

    // Tooltip bancadas
    function showTooltip(event, stationId) {
      const wb = workstations[stationId];
      if (!wb) return;
      tooltip.style.display = 'flex';
      tooltip.setAttribute('aria-hidden', 'false');
      tooltip.innerHTML = `
        <img src="${wb.image}" alt="${wb.name}" />
        <span>${wb.name}</span>
      `;
      const offset = 15;
      let x = event.pageX + offset;
      let y = event.pageY + offset;

      // Ajuste para não sair da tela
      if (x + tooltip.offsetWidth > window.innerWidth) {
        x = event.pageX - tooltip.offsetWidth - offset;
      }
      if (y + tooltip.offsetHeight > window.innerHeight) {
        y = event.pageY - tooltip.offsetHeight - offset;
      }

      tooltip.style.left = x + 'px';
      tooltip.style.top = y + 'px';
    }
    function hideTooltip() {
      tooltip.style.display = 'none';
      tooltip.setAttribute('aria-hidden', 'true');
      tooltip.innerHTML = '';
    }

    // Toggle modo escuro
    themeToggleBtn.addEventListener('click', () => {
      if (document.documentElement.getAttribute('data-theme') === 'dark') {
        document.documentElement.removeAttribute('data-theme');
        themeToggleBtn.setAttribute('aria-pressed', 'false');
        themeToggleBtn.textContent = 'Modo Escuro';
      } else {
        document.documentElement.setAttribute('data-theme', 'dark');
        themeToggleBtn.setAttribute('aria-pressed', 'true');
        themeToggleBtn.textContent = 'Modo Claro';
      }
    });

    loadData();
  </script>
</body>
</html>
